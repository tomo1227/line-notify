name: Check GitHub Contributions and Notify

on:
  schedule:
    - cron: "0 13 * * *" # UTCæ™‚é–“ã§æ¯æ—¥13æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ã§22æ™‚ï¼‰ã«å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Contributions on Main and Master Branches
        id: check_contributions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          START_DATE=$(date -u +"%Y-%m-%dT00:00:00Z")
          END_DATE=$(date +'%Y-%m-%dT%H:%M:%SZ' -u)
          echo USERNAME
          echo QUERY
          USERNAME="${{ github.repository_owner }}"
          QUERY="{\"query\": \"query { user(login: \\\"$USERNAME\\\") { contributionsCollection(from: \\\"$START_DATE\\\", to: \\\"$END_DATE\\\") { commitContributionsByRepository { repository { name, defaultBranchRef { name } } contributions(first: 100) { totalCount } } } } }\"}"

          RESPONSE=$(curl -H "Authorization: bearer $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$QUERY" https://api.github.com/graphql)
          echo "Response: $RESPONSE"
          echo "Query: $QUERY"
          echo "USERNAME: $USERNAME"
          MAIN_COUNT=$(echo $RESPONSE | jq '[.data.user.contributionsCollection.commitContributionsByRepository[] | select(.repository.defaultBranchRef.name == "main") | .contributions.totalCount] | add // 0')
          TOTAL_COUNT=$(($MAIN_COUNT))

          echo "Total contributions to main and master: $TOTAL_COUNT"
          echo "CONTRIBUTIONS_COUNT=$TOTAL_COUNT" >> $GITHUB_ENV

      - name: Send LINE Notification if No Contributions
        if: env.CONTRIBUTIONS_COUNT == '0'
        env:
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
          MESSAGE: "ğŸ‘®ä»Šæ—¥ã¯ã¾ã Commitã§ãã¦ã„ã¾ã›ã‚“!ä»Šã™ãã‚³ãƒŸãƒƒãƒˆã—ã‚ˆã†!!"
        run: |
          curl -X POST -H "Authorization: Bearer $LINE_TOKEN" -F "message=$MESSAGE" https://notify-api.line.me/api/notify

      - name: Send LINE Notification Test
        env:
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
          MESSAGE: "ãƒ†ã‚¹ãƒˆğŸ™ğŸ"
        run: |
          curl -X POST -H "Authorization: Bearer $LINE_TOKEN" -F "message=$MESSAGE" https://notify-api.line.me/api/notify
