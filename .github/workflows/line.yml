name: Check GitHub Contributions and Notify

on:
  schedule:
    - cron: "0 13 * * *" # UTC時間で毎日13時（日本時間で22時）に実行
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: test
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh api /octocat --method GET

      - name: Check for Contributions on Main and Master Branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +"%Y-%m-%dT00:00:00Z")
          TOTAL_CONTRIBUTIONS=$(gh api graphql -F DATE=$DATE -f query='
            query ($DATE: DateTime){
              viewer {
                contributionsCollection(from: $DATE, to: $DATE) {
                  contributionCalendar{
                    totalContributions
                  }
                }
              }
            }
            '| jq '.data.viewer.contributionsCollection.contributionCalendar.totalContributions'
          )

          echo "Total contributions to main: $TOTAL_CONTRIBUTIONS"
          echo "CONTRIBUTIONS_COUNT=$TOTAL_CONTRIBUTIONS" >> $GITHUB_ENV

      - name: Send LINE Notification if No Contributions
        if: env.CONTRIBUTIONS_COUNT == '0'
        env:
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
          MESSAGE: "👮今日はまだCommitできていません!今すぐコミットしよう!!"
        run: |
          curl -X POST -H "Authorization: Bearer $LINE_TOKEN" -F "message=$MESSAGE" https://notify-api.line.me/api/notify
