name: Check GitHub Contributions and Notify

on:
  schedule:
    - cron: "0 13 * * *" # UTCæ™‚é–“ã§æ¯æ—¥13æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ã§22æ™‚ï¼‰ã«å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: test
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh api /octocat --method GET

      - name: Check for Contributions on Main and Master Branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +"%Y-%m-%dT00:00:00Z")
          TOTAL_CONTRIBUTIONS=$(gh api graphql -F DATE=$DATE -f query='
            query ($DATE: DateTime){
              viewer {
                contributionsCollection(from: $DATE, to: $DATE) {
                  contributionCalendar{
                    totalContributions
                  }
                }
              }
            }
            '| jq '.data.viewer.contributionsCollection.contributionCalendar.totalContributions'
          )

          echo "Total contributions to main: $TOTAL_CONTRIBUTIONS"
          echo "CONTRIBUTIONS_COUNT=$TOTAL_CONTRIBUTIONS" >> $GITHUB_ENV

      - name: Send LINE Notification if No Contributions
        if: env.CONTRIBUTIONS_COUNT == '0'
        env:
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
          MESSAGE: "ğŸ‘®ä»Šæ—¥ã¯ã¾ã Commitã§ãã¦ã„ã¾ã›ã‚“!ä»Šã™ãã‚³ãƒŸãƒƒãƒˆã—ã‚ˆã†!!"
        run: |
          curl -X POST -H "Authorization: Bearer $LINE_TOKEN" -F "message=$MESSAGE" https://notify-api.line.me/api/notify
